# 銀行口座ステージ獲得条件の月次バッチ処理シミュレーション

CSVデータに基づいて各テーブルに挿入されるデータをシミュレーションします。まず、バッチ処理の流れを簡単に説明し、その後各顧客のデータを個別に解説します。

## バッチ処理の流れ

1. CSVデータを読み込む
2. 各顧客の条件を評価し、基本ステージを判定
3. ランクアップ条件を適用し、最終ステージを決定
4. 計算結果をテーブルに保存
5. ステージ遷移を記録

頂いたCSVデータを元に、銀行口座ステージ獲得条件のバッチ処理をシミュレーションします。各顧客のデータがどのようにテーブルに格納されるかを解説していきます。

## テスト実行の前提条件

このシミュレーションでは、CSVデータの処理日が2025年4月30日で、ステージ適用期間が2025年5月1日から2025年5月31日までとします。

## 1. 顧客CUS001のデータ処理

**説明**: 基本条件を満たさない顧客（総残高250万円、ステージなし）

**処理ロジック**:

1. 顧客の全指標が基本条件を満たさないため、ステージは「NONE」のまま
2. ランクアップ条件も満たさないため変更なし

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 1  | CUS001      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | NONE             | 2500000.00    | 0.00                     | 0.00                     | 0.00                        | 0.00                              | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 1  | 1              | 1            | false  | 2500000.00      | 2025-04-30 12:00:00 |
| 2  | 1              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 3  | 1              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 4  | 1              | 4            | false  | 0.00            | 2025-04-30 12:00:00 |
| 5  | 1              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 6  | 1              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

- 遷移なし（ステージが変わらないため記録なし）

## 2. 顧客CUS002のデータ処理

**説明**: 総残高でシルバーステージ獲得

**処理ロジック**:

1. 顧客の総残高が350万円で、シルバーステージの条件（300万円以上）を満たす
2. ランクアップ条件を満たさないため、そのままシルバーステージとなる

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 2  | CUS002      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | SILVER           | 3500000.00    | 0.00                     | 0.00                     | 0.00                        | 0.00                              | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 7  | 2              | 1            | true   | 3500000.00      | 2025-04-30 12:00:00 |
| 8  | 2              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 9  | 2              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 10 | 2              | 4            | false  | 0.00            | 2025-04-30 12:00:00 |
| 11 | 2              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 12 | 2              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 1  | CUS002      | 2              | NONE                | SILVER             | 2025-05-01      | 2025-04-30 12:00:00 |

## 3. 顧客CUS003のデータ処理

**説明**: 外貨と投資信託の合計額でゴールドステージ獲得

**処理ロジック**:

1. 顧客の外貨預金（300万円）と投資信託（300万円）の合計600万円がゴールドステージの条件（500万円以上1000万円未満）を満たす
2. 現在のステージがシルバーで、新しいステージがゴールドなので、ステージアップ
3. ランクアップ条件は満たさない

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 3  | CUS003      | 2025-04-30       | 2025-05-01 | 2025-05-31 | SILVER             | GOLD             | 8800000.00    | 3000000.00               | 3000000.00               | 6000000.00                  | 0.00                              | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 13 | 3              | 1            | true   | 8800000.00      | 2025-04-30 12:00:00 |
| 14 | 3              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 15 | 3              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 16 | 3              | 4            | true   | 6000000.00      | 2025-04-30 12:00:00 |
| 17 | 3              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 18 | 3              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 2  | CUS003      | 3              | SILVER              | GOLD               | 2025-05-01      | 2025-04-30 12:00:00 |

## 4. 顧客CUS004のデータ処理

**説明**: 投資残高減少でゴールドからシルバーへダウングレード

**処理ロジック**:

1. 顧客の外貨預金（100万円）と投資信託（100万円）の合計200万円が、ゴールドステージの条件（500万円以上）を満たさない
2. 総残高900万円はシルバーステージの条件（300万円以上）を満たす
3. 現在のステージがゴールドだが、新しいステージがシルバーなので、ダウングレード
4. ランクアップ条件は満たさない

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 4  | CUS004      | 2025-04-30       | 2025-05-01 | 2025-05-31 | GOLD               | SILVER           | 9000000.00    | 1000000.00               | 1000000.00               | 2000000.00                  | 0.00                              | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 19 | 4              | 1            | true   | 9000000.00      | 2025-04-30 12:00:00 |
| 20 | 4              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 21 | 4              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 22 | 4              | 4            | false  | 2000000.00      | 2025-04-30 12:00:00 |
| 23 | 4              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 24 | 4              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 3  | CUS004      | 4              | GOLD                | SILVER             | 2025-05-01      | 2025-04-30 12:00:00 |

## 5. 顧客CUS005のデータ処理

**説明**: 投資額減少でプラチナからゴールドへダウングレード

**処理ロジック**:

1. 顧客の外貨預金（400万円）と投資信託（400万円）の合計800万円が、プラチナステージの条件（1000万円以上）を満たさない
2. 合計800万円はゴールドステージの条件（500万円以上1000万円未満）を満たす
3. 現在のステージがプラチナだが、新しいステージがゴールドなので、ダウングレード
4. ランクアップ条件は満たさない

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 5  | CUS005      | 2025-04-30       | 2025-05-01 | 2025-05-31 | PLATINUM           | GOLD             | 13000000.00   | 4000000.00               | 4000000.00               | 8000000.00                  | 0.00                              | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 25 | 5              | 1            | true   | 13000000.00     | 2025-04-30 12:00:00 |
| 26 | 5              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 27 | 5              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 28 | 5              | 4            | true   | 8000000.00      | 2025-04-30 12:00:00 |
| 29 | 5              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 30 | 5              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 4  | CUS005      | 5              | PLATINUM            | GOLD               | 2025-05-01      | 2025-04-30 12:00:00 |

## 6. 顧客CUS006のデータ処理

**説明**: 外貨預金の積立購入でシルバーステージ獲得

**処理ロジック**:

1. 顧客の月間外貨購入額が4万円で、シルバーステージの条件（3万円以上）を満たす
2. 現在のステージがNONEで、新しいステージがシルバーなので、ステージアップ
3. ランクアップ条件は満たさない

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 6  | CUS006      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | SILVER           | 1000000.00    | 0.00                     | 0.00                     | 0.00                        | 40000.00                          | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 31 | 6              | 1            | false  | 1000000.00      | 2025-04-30 12:00:00 |
| 32 | 6              | 2            | true   | 40000.00        | 2025-04-30 12:00:00 |
| 33 | 6              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 34 | 6              | 4            | false  | 0.00            | 2025-04-30 12:00:00 |
| 35 | 6              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 36 | 6              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 5  | CUS006      | 6              | NONE                | SILVER             | 2025-05-01      | 2025-04-30 12:00:00 |

## 7. 顧客CUS007のデータ処理

**説明**: 投資信託の積立購入でシルバーステージ獲得

**処理ロジック**:

1. 顧客の月間投資信託購入額が4万円で、シルバーステージの条件（3万円以上）を満たす
2. 現在のステージがNONEで、新しいステージがシルバーなので、ステージアップ
3. ランクアップ条件は満たさない

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 7  | CUS007      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | SILVER           | 1000000.00    | 0.00                     | 0.00                     | 0.00                        | 0.00                              | 40000.00                          | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 37 | 7              | 1            | false  | 1000000.00      | 2025-04-30 12:00:00 |
| 38 | 7              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 39 | 7              | 3            | true   | 40000.00        | 2025-04-30 12:00:00 |
| 40 | 7              | 4            | false  | 0.00            | 2025-04-30 12:00:00 |
| 41 | 7              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 42 | 7              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 6  | CUS007      | 7              | NONE                | SILVER             | 2025-05-01      | 2025-04-30 12:00:00 |

## 8. 顧客CUS008のデータ処理

**説明**: シルバーからプラチナへ投資残高増加でアップグレード

**処理ロジック**:

1. 顧客の外貨預金（600万円）と投資信託（600万円）の合計1200万円が、プラチナステージの条件（1000万円以上）を満たす
2. 現在のステージがシルバーで、新しいステージがプラチナなので、2ランクアップ
3. ランクアップ条件は満たさない

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 8  | CUS008      | 2025-04-30       | 2025-05-01 | 2025-05-31 | SILVER             | PLATINUM         | 13000000.00   | 6000000.00               | 6000000.00               | 12000000.00                 | 0.00                              | 0.00                              | 0.00                 | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 43 | 8              | 1            | true   | 13000000.00     | 2025-04-30 12:00:00 |
| 44 | 8              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 45 | 8              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 46 | 8              | 4            | true   | 12000000.00     | 2025-04-30 12:00:00 |
| 47 | 8              | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 48 | 8              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 7  | CUS008      | 8              | SILVER              | PLATINUM           | 2025-05-01      | 2025-04-30 12:00:00 |

## 9. 顧客CUS009のデータ処理

**説明**: 住宅ローンによるランクアップ

**処理ロジック**:

1. 顧客の基本条件は満たさないが、住宅ローン残高がある（1000万円）
2. 住宅ローンはランクアップ条件であり、1ランクアップ
3. 基本ステージはNONEだが、ランクアップによりシルバーとなる

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 9  | CUS009      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | SILVER           | 1000000.00    | 0.00                     | 0.00                     | 0.00                        | 0.00                              | 0.00                              | 10000000.00          | 0                         | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 49 | 9              | 1            | false  | 1000000.00      | 2025-04-30 12:00:00 |
| 50 | 9              | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 51 | 9              | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 52 | 9              | 4            | false  | 0.00            | 2025-04-30 12:00:00 |
| 53 | 9              | 5            | true   | 10000000.00     | 2025-04-30 12:00:00 |
| 54 | 9              | 6            | false  | 0               | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 8  | CUS009      | 9              | NONE                | SILVER             | 2025-05-01      | 2025-04-30 12:00:00 |

## 10. 顧客CUS010のデータ処理

**説明**: FX取引によるランクアップ

**処理ロジック**:

1. 顧客の基本条件は満たさないが、月間FX取引量が1,200枚あり、ランクアップ条件（1,000枚以上）を満たす
2. 基本ステージはNONEだが、ランクアップによりシルバーとなる

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 10 | CUS010      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | SILVER           | 1000000.00    | 0.00                     | 0.00                     | 0.00                        | 0.00                              | 0.00                              | 0.00                 | 1200                      | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 55 | 10             | 1            | false  | 1000000.00      | 2025-04-30 12:00:00 |
| 56 | 10             | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 57 | 10             | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 58 | 10             | 4            | false  | 0.00            | 2025-04-30 12:00:00 |
| 59 | 10             | 5            | false  | 0.00            | 2025-04-30 12:00:00 |
| 60 | 10             | 6            | true   | 1200            | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 9  | CUS010      | 10             | NONE                | SILVER             | 2025-05-01      | 2025-04-30 12:00:00 |

## 11. 顧客CUS011のデータ処理

**説明**: 複数条件によるダブルランクアップ

**処理ロジック**:

1. 顧客の外貨預金（600万円）と投資信託（600万円）の合計1200万円が、プラチナステージの条件（1000万円以上）を満たす
2. さらに住宅ローン残高（1000万円）とFX取引（1,200枚）の両方のランクアップ条件を満たしている
3. 基本条件ではプラチナステージの要件を満たしているが、これ以上ランクアップする余地がないため、最終的なステージはプラチナのまま

**customer_stage_calculations テーブルへの挿入データ**:

| id | customer_id | calculation_date | valid_from | valid_to   | current_stage_code | final_stage_code | total_balance | foreign_currency_balance | investment_trust_balance | combined_investment_balance | monthly_foreign_currency_purchase | monthly_investment_trust_purchase | housing_loan_balance | monthly_fx_trading_volume | created_at          |
|----|-------------|------------------|------------|------------|--------------------|------------------|---------------|--------------------------|--------------------------|-----------------------------|-----------------------------------|-----------------------------------|----------------------|---------------------------|---------------------|
| 11 | CUS011      | 2025-04-30       | 2025-05-01 | 2025-05-31 | NONE               | PLATINUM         | 13000000.00   | 6000000.00               | 6000000.00               | 12000000.00                 | 0.00                              | 0.00                              | 10000000.00          | 1200                      | 2025-04-30 12:00:00 |

**condition_evaluation_results テーブルへの挿入データ**:

| id | calculation_id | condition_id | is_met | evaluated_value | created_at          |
|----|----------------|--------------|--------|-----------------|---------------------|
| 61 | 11             | 1            | true   | 13000000.00     | 2025-04-30 12:00:00 |
| 62 | 11             | 2            | false  | 0.00            | 2025-04-30 12:00:00 |
| 63 | 11             | 3            | false  | 0.00            | 2025-04-30 12:00:00 |
| 64 | 11             | 4            | true   | 12000000.00     | 2025-04-30 12:00:00 |
| 65 | 11             | 5            | true   | 10000000.00     | 2025-04-30 12:00:00 |
| 66 | 11             | 6            | true   | 1200            | 2025-04-30 12:00:00 |

**stage_transitions テーブルへの挿入データ**:

| id | customer_id | calculation_id | previous_stage_code | current_stage_code | transition_date | created_at          |
|----|-------------|----------------|---------------------|--------------------|-----------------|---------------------|
| 10 | CUS011      | 11             | NONE                | PLATINUM           | 2025-05-01      | 2025-04-30 12:00:00 |

## 月次バッチの処理ロジックの概要

このバッチ処理では、以下のようなロジックが実行されています：

1. **基本ステージの判定**:
    - シルバーステージ: 総残高300万円以上、または月間外貨購入額3万円以上、または月間投資信託購入額3万円以上のいずれか
    - ゴールドステージ: 外貨預金と投資信託の合計が500万円以上1000万円未満
    - プラチナステージ: 外貨預金と投資信託の合計が1000万円以上

2. **ランクアップ判定**:
    - 住宅ローン残高がある場合: 1ランクアップ
    - 月間FX取引量が1000枚以上の場合: 1ランクアップ
    - 両方満たす場合: 2ランクアップ（ただし最終的なステージはプラチナまで）

3. **データ処理の流れ**:
    1. CSVデータを読み込み
    2. 各顧客の基本ステージを判定
    3. ランクアップ条件を適用
    4. 最終ステージを決定
    5. 顧客の計算結果を記録
    6. 条件評価結果を記録
    7. ステージ遷移があれば記録

各顧客の例を通して、バッチ処理が様々なケースに適切に対応できることが確認できました。このバッチ処理によって、銀行は顧客の取引状況に基づいて適切なステージを自動的に割り当て、それに応じた特典を提供できるようになります。
